(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{542:function(s,a,t){"use strict";t.r(a);var e=t(6),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("其他方式安装GitLab：\n"),t("RouterLink",{attrs:{to:"/blogs/docker/2021/08/docker-compose-install-harbor.html"}},[s._v("使用docker-compose安装Harbor")])],1)]),t("h2",{attrs:{id:"gitlab介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab介绍"}},[s._v("#")]),s._v(" GitLab介绍")]),s._v(" "),t("p",[s._v("  Gitlab（gitlab.com）是一个开源的Git代码仓库系统，可以实现自托管的Github项目，即用于构建私有的代码托管平台和项目管理系统。系统基于Ruby on Rails开发，速度快、安全稳定。"),t("br"),s._v("\n  它拥有与Github类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序(Wall)进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。")]),s._v(" "),t("h2",{attrs:{id:"前期准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前期准备"}},[s._v("#")]),s._v(" 前期准备")]),s._v(" "),t("ol",[t("li",[s._v("安装Helm")]),s._v(" "),t("li",[s._v("安装k8s")]),s._v(" "),t("li",[s._v("安装cpeh")])]),s._v(" "),t("h2",{attrs:{id:"安装gitlab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装gitlab"}},[s._v("#")]),s._v(" 安装GitLab")]),s._v(" "),t("ol",[t("li",[s._v("添加 Git 仓库：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加Harbor源")]),s._v("\nhhelm repo "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" gitlab https://charts.gitlab.io\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新Helm")]),s._v("\nhelm repo update\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("搜索可用的Harbor版本")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("helm search repo gitlab\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可以看到如下结果："),t("br"),s._v(" "),t("img",{attrs:{src:"/img/blogs/2021/11/helm-search-gitlab.png",alt:"文件截图"}})]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("将Harbor的chart包下载到本地")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("helm fetch gitlab/gitlab\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("解压文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xvf gitlab-5.4.2.tgz\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压完成后进入目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" harbor\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ol",{attrs:{start:"5"}},[t("li",[s._v("按需修改配置文件"),t("br"),s._v("\n  修改配置文件 values.yaml，具体查看GitHub上面的配置列表"),t("a",{attrs:{href:"https://github.com/goharbor/harbor-helm/blob/master/README.md#configuration",target:"_blank",rel:"noopener noreferrer"}},[s._v("Configuration"),t("OutboundLink")],1),s._v("。"),t("br"),s._v("\n  value.yml文件是最全的配置文件，如果这个那么细致定制化需求，可以按需创建自己的配置，这里创建了my_value.conf，内容如下：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("expose:\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 类型修改为nodePort模式，默认为ingress模式，按需修改即可")]),s._v("\n  type: nodePort\n  tls:\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭tls验证")]),s._v("\n    enabled: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  nodePort:\n    ports:\n      http:\n        nodePort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30002")]),s._v("\n      https:\n        nodePort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30003")]),s._v("\n      notary:\n        nodePort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30004")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 访问路径")]),s._v("\nexternalURL: http://10.169.136.38:30002\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储挂载设置")]),s._v("\npersistence:\n  persistentVolumeClaim:\n    registry:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n    chartmuseum:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n    jobservice:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n    database:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n    redis:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n    trivy:\n      storageClass: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rook-cephfs"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("其中"),t("code",[s._v("nis-rook-cephfs")]),s._v("是预先创建好的storageClass")]),s._v(" "),t("ol",{attrs:{start:"6"}},[t("li",[s._v("部署Harbor")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("helm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" gitlab ./ --namespace gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set global.edition"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ce "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set global.hosts.domain"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("example.com "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set global.hosts.externalIP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.38 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set certmanager-issuer.email"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("me@example.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("此时就已安装完成了")]),s._v(" "),t("h2",{attrs:{id:"登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登录"}},[s._v("#")]),s._v(" 登录")]),s._v(" "),t("p",[s._v("默认用户名是admin，密码是Harbor12345。")]),s._v(" "),t("h3",{attrs:{id:"页面登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#页面登录"}},[s._v("#")]),s._v(" 页面登录")]),s._v(" "),t("p",[s._v("根据配置中的地址，"),t("code",[s._v("http://10.100.159.128:30002")]),s._v("即可登录web管理页面进行使用。")]),s._v(" "),t("h3",{attrs:{id:"命令登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令登录"}},[s._v("#")]),s._v(" 命令登录")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker login -u admin -p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'密码'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.38:30002\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"修改docker配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改docker配置"}},[s._v("#")]),s._v(" 修改docker配置")]),s._v(" "),t("p",[s._v("  由于Docker自从 1.3.x之后，docker registry 交互默认使用的是HTTPS，而我们搭建的 Harbor 使用的是HTTP，所以为了避免 pull/push 镜像时得到错误："),t("code",[s._v("http: server gave HTTP response to HTTPS client")]),s._v("，需要修改 docker 的配置文件 /etc/docker/daemon.json，加入以下配置：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/docker/daemon.json\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在json中增加如下配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"insecure-registries"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.169.136.38:30002"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启Docker服务")]),s._v("\nsystemctl daemon-reload\nsystemctl restart docker \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("p",[t("a",{attrs:{href:"http://kpali.me/2020/05/13/deploy-harbor-in-kubernetes.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://kpali.me/2020/05/13/deploy-harbor-in-kubernetes.html"),t("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);