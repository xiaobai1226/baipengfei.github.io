(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{545:function(s,a,t){"use strict";t.r(a);var e=t(6),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),t("ol",[t("li",[s._v("系统版本：Redhat7.8")]),s._v(" "),t("li",[s._v("Ceph的docker镜像版本：nautilus")]),s._v(" "),t("li",[s._v("Docker版本：20.10.8")])]),s._v(" "),t("h2",{attrs:{id:"介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[s._v("#")]),s._v(" 介绍")]),s._v(" "),t("p",[s._v("  Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。"),t("br"),s._v("\n  Ceph项目最早起源于Sage就读博士期间的工作（最早的成果于2004年发表），并随后贡献给开源社区。在经过了数年的发展之后，目前已得到众多云计算厂商的支持并被广泛应用。RedHat及OpenStack都可与Ceph整合以支持虚拟机镜像的后端存储。")]),s._v(" "),t("h3",{attrs:{id:"ceph特点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ceph特点"}},[s._v("#")]),s._v(" Ceph特点")]),s._v(" "),t("ol",[t("li",[s._v("高性能\n"),t("ul",[t("li",[s._v("摒弃了传统的集中式存储元数据寻址的方案，采用CRUSH算法，数据分布均衡，并行度高。")]),s._v(" "),t("li",[s._v("考虑了容灾域的隔离，能够实现各类负载的副本放置规则，例如跨机房、机架感知等。")]),s._v(" "),t("li",[s._v("能够支持上千个存储节点的规模，支持TB到PB级的数据。")])])]),s._v(" "),t("li",[s._v("高可用性\n"),t("ul",[t("li",[s._v("副本数可以灵活控制。")]),s._v(" "),t("li",[s._v("支持故障域分隔，数据强一致性。")]),s._v(" "),t("li",[s._v("多种故障场景自动进行修复自愈。")]),s._v(" "),t("li",[s._v("没有单点故障，自动管理。")])])]),s._v(" "),t("li",[s._v("高可扩展性\n"),t("ul",[t("li",[s._v("去中心化。")]),s._v(" "),t("li",[s._v("扩展灵活。")]),s._v(" "),t("li",[s._v("随着节点增加而线性增长。")])])]),s._v(" "),t("li",[s._v("特性丰富\n"),t("ul",[t("li",[s._v("支持三种存储接口：块存储、文件存储、对象存储。")]),s._v(" "),t("li",[s._v("支持自定义接口，支持多种语言驱动。")])])])]),s._v(" "),t("h2",{attrs:{id:"架构规划"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构规划"}},[s._v("#")]),s._v(" 架构规划")]),s._v(" "),t("h2",{attrs:{id:"前期准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前期准备"}},[s._v("#")]),s._v(" 前期准备")]),s._v(" "),t("p",[s._v("部署Ceph之前我们需要对自身机器的环境做一个前期操作。主要涉及到防火墙，主机名等设置。")]),s._v(" "),t("ol",[t("li",[s._v("关闭防火墙")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("systemctl stop firewalld\nsystemctl disable firewalld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("关闭selinux(linux的安全子系统)")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/enforcing/disabled/'")]),s._v(" /etc/selinux/config\nsetenforce "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"title"}),t("p",[s._v("正式环境实际部署时，最好通过加入IP白名单的方式来操作，而不是直接关闭防火墙。")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("设置主机名，分别把三台虚拟机的主机名设置成想设置的名称，本文为obptest2，obptest3，obptest4。")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("hostnamectl set-hostname obptest2\nhostnamectl set-hostname obptest3\nhostnamectl set-hostname obptest4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[t("p",[s._v("SSH免密登陆配置")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("在三个节点上分别执行下列命令配置host，需将ip与主机名替换为自己服务器的")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n10.169.136.38 obptest2\n10.169.136.39 obptest3\n10.169.136.40 obptest4\nEOF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在主节点obptest2配置免密登录到obptest3和obptest4\n下面命令在主节点obptest2上执行。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("ssh-keygen\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#把密钥发给obptest3、obptest4")]),s._v("\nssh-copy-id obptest3 \nssh-copy-id obptest4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("内核参数优化")])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#调整内核参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/sysctl.conf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nkernel.pid_max=4194303\nvm.swappiness = 0\nEOF")]),s._v("\nsysctl -p\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# read_ahead, 通过数据预读并且记载到随机访问内存方式提高磁盘读操作，根据一些Ceph的公开分享，8192是比较理想的值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8192"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/block/sda/queue/read_ahead_kb\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# I/O Scheduler，关于I/O Scheculder的调整，简单说SSD要用noop，SATA/SAS使用deadline。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deadline"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/block/sda/queue/scheduler\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"noop"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/block/sda/queue/scheduler\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ol",{attrs:{start:"6"}},[t("li",[s._v("打开ntp服务"),t("br"),s._v("\nntp服务的作用是用于同步不同机器的时间。如果不打开ntp服务的话，则有可能会出现 clock skew detected on mon.obptest2, mon.obptest3这种问题。")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看ntp，如果状态是inactive，则表示没启动")]),s._v("\nsystemctl status ntpd\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动ntp服务")]),s._v("\nsystemctl start ntpd\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置开启自启动ntp服务")]),s._v("\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" ntpd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ol",{attrs:{start:"7"}},[t("li",[t("p",[s._v("安装docker"),t("br"),s._v("\n所有节点均需安装，具体安装步骤见："),t("RouterLink",{attrs:{to:"/blogs/docker/2021/08/docker-install.html"}},[s._v("Docker安装教程")])],1)]),s._v(" "),t("li",[t("p",[s._v("其他配置"),t("br"),s._v("\n将容器内的ceph命令alias到本地，方便使用，其他命令也以参考添加")])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'alias ceph=\"docker exec mon ceph\"'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/profile\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /etc/profile\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("h3",{attrs:{id:"创建ceph目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建ceph目录"}},[s._v("#")]),s._v(" 创建Ceph目录")]),s._v(" "),t("ol",[t("li",[s._v("创建目录"),t("br"),s._v("\n在宿主机上创建Ceph目录与容器建立映射，便于直接操纵管理Ceph配置文件，以root身份在主节点obptest2上创建文件夹，命令如下：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /app/ceph/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("admin,etc,lib,logs,data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("该命令会一次创建5个指定的目录，注意逗号分隔，不能有空格。其中：")]),s._v(" "),t("ol",[t("li",[s._v("admin文件夹下用于存储启动脚本")]),s._v(" "),t("li",[s._v("etc文件夹下存放了ceph.conf等配置文件")]),s._v(" "),t("li",[s._v("lib文件夹下存放了各组件的密钥文件")]),s._v(" "),t("li",[s._v("logs文件夹下存放了ceph的日志文件")]),s._v(" "),t("li",[s._v("data文件夹用于挂载文件")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("对docker内用户进行授权")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker内用户id是167，这里进行授权")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("167")]),s._v(":167 /app/ceph/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"拉取ceph镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#拉取ceph镜像"}},[s._v("#")]),s._v(" 拉取Ceph镜像")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"title"}),t("p",[s._v("拉取时注意版本，不要贸然采用最新版，有些会存在缺陷，安装的时候会出现问题，这里采用的nautilus版本。")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker pull ceph/daemon:master-4d96298-nautilus-centos-7-x86_64\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"启动mon服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动mon服务"}},[s._v("#")]),s._v(" 启动MON服务")]),s._v(" "),t("p",[s._v("三台节点上都需安装Mon服务。先在主节点操作。")]),s._v(" "),t("ol",[t("li",[s._v("在主节点的/app/ceph/admin目录下创建start_mon.sh脚本：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("/bin/bash\ndocker run -d --net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ceph-mon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v /etc/localtime:/etc/localtime "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v /app/ceph/etc:/etc/ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v /app/ceph/lib:/var/lib/ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v /app/ceph/logs:/var/log/ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MON_IP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.38,10.169.136.39,10.169.136.40 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CEPH_PUBLIC_NETWORK")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.0/24 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    ceph/daemon:master-4d96298-nautilus-centos-7-x86_64 mon\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("ol",[t("li",[s._v("name参数，指定节点名称， 这里设为ceph-mon")]),s._v(" "),t("li",[s._v("建立宿主机与容器的目录映射关系，包含etc、lib、logs目录")]),s._v(" "),t("li",[s._v("MON_IP 参数指定mon服务的节点IP信息")]),s._v(" "),t("li",[s._v("CEPH_PUBLIC_NETWORK参数，指定mon的ip网段信息，如果跨网段需写上所有的网段（注意这里是24位，将最后一位改为0就可以）。")]),s._v(" "),t("li",[s._v("最后指定镜像版本， mon为参数， 代表启动的是mon服务，不能乱填。")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("给脚本增加权限：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("755")]),s._v(" -R  /app/ceph/admin/start_mon.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("启动mon服务：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/app/ceph/admin/start_mon.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("创建Ceph配置文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /app/ceph/etc/ceph.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("配置内容及说明：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("global"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nfsid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 646aa796-0240-4dd8-83b3-8781779a8feb\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mon节点名称")]),s._v("\nmon initial members "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" CENTOS7-1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mon 主机地址信息")]),s._v("\nmon "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.38,10.169.136.39,10.169.136.40\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对外访问的IP网段")]),s._v("\npublic network "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.0/24\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群IP网段")]),s._v("\ncluster network "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.169")]),s._v(".136.0/24\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# journal 大小 ， 一般设为（磁盘带宽 * 文件同步刷新时间）的2倍")]),s._v("\nosd journal size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置pool池默认分配数量")]),s._v("\nosd pool default size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 容忍更多的时钟误差")]),s._v("\nmon clock drift allowed "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\nmon clock drift warn backoff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许删除pool")]),s._v("\nmon_allow_pool_delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mgr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启WEB仪表盘")]),s._v("\nmgr modules "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" dashboard\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("client.rgw.CENTOS7-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置rgw网关的web访问端口")]),s._v("\nrgw_frontends "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=20003"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("ol",{attrs:{start:"5"}},[t("li",[t("p",[s._v("检查mon服务状态\n出现HEALTH_OK代表服务启动成功：")])]),s._v(" "),t("li",[t("p",[s._v("将主节点配置复制到其他两个节点， 覆盖/app/ceph/目录")])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -r /app/ceph/ root@10.169.136.39:/app/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -r /app/ceph/ root@10.169.136.40:/app/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("复制完成之后， 分别在其他两个节点启动mon服务")]),s._v(" "),t("ol",{attrs:{start:"7"}},[t("li",[s._v("检查集群状态\n这里我们只搭建了三个mon节点， 正常的话可以看到已成功组件集群：")])]),s._v(" "),t("h3",{attrs:{id:"启动osd服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动osd服务"}},[s._v("#")]),s._v(" 启动OSD服务")]),s._v(" "),t("p",[s._v("OSD服务是对象存储守护进程，负责把对象存储到本地文件系统，必须要有一块独立的磁盘作为存储，如果没有独立磁盘则需要在Linux下面创建一个虚拟磁盘进行挂载。"),t("br"),s._v("\n下面分别介绍两种挂载方式：")]),s._v(" "),t("h4",{attrs:{id:"无独立磁盘"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#无独立磁盘"}},[s._v("#")]),s._v(" 无独立磁盘")]),s._v(" "),t("p",[s._v("如果没有独立磁盘，我们可以创建一个虚拟磁盘进行挂载，步骤如下：")]),s._v(" "),t("ol",[t("li",[s._v("初始化10T的镜像文件：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /app/ceph/ceph-disk "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/datavg-lv_desc_1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("of")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/app/ceph/ceph-disk/ceph-disk-01 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1T "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("将镜像文件虚拟成块设备：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("losetup -f /app/ceph/ceph-disk/ceph-disk-01 \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("格式化（名称根据fdisk -l进行查询）：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mkfs.xfs -f /dev/loop0 \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("挂载文件系统，就是将loop0磁盘挂载到/dev/osd目录下,")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /dev/osd \n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" /dev/loop0 /dev/osd \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h4",{attrs:{id:"有独立磁盘"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#有独立磁盘"}},[s._v("#")]),s._v(" 有独立磁盘")]),s._v(" "),t("ol",[t("li",[s._v("直接格式化")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 名称根据fdisk -l进行查询")]),s._v("\nmkfs.xfs -f /dev/sdb\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("挂载文件系统：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /dev/osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" /dev/sdb /dev/osd \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"查看挂载结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看挂载结果"}},[s._v("#")]),s._v(" 查看挂载结果")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v(" -h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"启动osd服务-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动osd服务-2"}},[s._v("#")]),s._v(" 启动OSD服务")]),s._v(" "),t("p",[s._v("以下步骤在三台节点依次进行")]),s._v(" "),t("ol",[t("li",[s._v("创建OSD磁盘\nOSD服务是对象存储守护进程， 负责把对象存储到本地文件系统， 必须要有一块独立的磁盘作为存储。")])]),s._v(" "),t("h3",{attrs:{id:"启动mgr服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动mgr服务"}},[s._v("#")]),s._v(" 启动mgr服务")]),s._v(" "),t("h3",{attrs:{id:"启动rgw服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动rgw服务"}},[s._v("#")]),s._v(" 启动rgw服务")]),s._v(" "),t("h3",{attrs:{id:"启动mds服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动mds服务"}},[s._v("#")]),s._v(" 启动mds服务")]),s._v(" "),t("h3",{attrs:{id:"安装dashboard管理后台"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装dashboard管理后台"}},[s._v("#")]),s._v(" 安装Dashboard管理后台")]),s._v(" "),t("h3",{attrs:{id:"创建fs文件系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建fs文件系统"}},[s._v("#")]),s._v(" 创建FS文件系统")]),s._v(" "),t("h3",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])]),s._v(" "),t("ol",[t("li",[s._v("拉取ceph\n这里用到了 dockerhub 上最流行的 ceph/daemon 镜像（这里需要拉取nautilus版本的ceph，latest-nautilus）")])]),s._v(" "),t("p",[s._v("docker pull ceph/daemon:latest-nautilus\n5. 编写脚本（脚本都放在admin文件夹下）")]),s._v(" "),t("ol",[t("li",[s._v("start_mon.sh")])]),s._v(" "),t("p",[s._v("!/bin/bash\ndocker run -d --net=host "),t("br"),s._v("\n--name=mon "),t("br"),s._v("\n-v /etc/localtime:/etc/localtime "),t("br"),s._v("\n-v /usr/local/ceph/etc:/etc/ceph "),t("br"),s._v("\n-v /usr/local/ceph/lib:/var/lib/ceph "),t("br"),s._v("\n-v /usr/local/ceph/logs:/var/log/ceph "),t("br"),s._v("\n-e MON_IP=192.168.161.137,192.168.161.135,192.168.161.136 "),t("br"),s._v("\n-e CEPH_PUBLIC_NETWORK=192.168.161.0/24 "),t("br"),s._v("\nceph/daemon:latest-nautilus  mon\n这个脚本是为了启动监视器，监视器的作用是维护整个Ceph集群的全局状态。一个集群至少要有一个监视器，最好要有奇数个监视器。方便当一个监视器挂了之后可以选举出其他可用的监视器。启动脚本说明： 1. name参数，指定节点名称，这里设为mon 2. -v xxx:xxx 是建立宿主机与容器的目录映射关系，包含 etc、lib、logs目录。 3. MON_IP是Docker运行的IP地址（通过ifconfig来查询，取ens33里的inet那个IP）,这里我们有3台服务器，那么MAN_IP需要写上3个IP，如果IP是跨网段的CEPH_PUBLIC_NETWORK必须写上所有网段。 4. CEPH_PUBLIC_NETWORK配置了运行Docker主机所有网段 这里必须指定nautilus版本，不然会默认操作最新版本ceph，mon必须与前面定义的name保持一致。")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("start_osd.sh")])]),s._v(" "),t("p",[s._v("#!/bin/bash\ndocker run -d "),t("br"),s._v("\n--name=osd "),t("br"),s._v("\n--net=host "),t("br"),s._v("\n--restart=always "),t("br"),s._v("\n--privileged=true "),t("br"),s._v("\n--pid=host "),t("br"),s._v("\n-v /etc/localtime:/etc/localtime "),t("br"),s._v("\n-v /usr/local/ceph/etc:/etc/ceph "),t("br"),s._v("\n-v /usr/local/ceph/lib:/var/lib/ceph "),t("br"),s._v("\n-v /usr/local/ceph/logs:/var/log/ceph "),t("br"),s._v("\n-v /dev/osd:/var/lib/ceph/osd "),t("br"),s._v("\nceph/daemon:latest-nautilus  osd_directory\n这个脚本是用于启动OSD组件的，OSD（Object Storage Device）是RADOS组件，其作用是用于存储资源。 脚本说明： 1. name 是用于指定OSD容器的名称\n2. net 是用于指定host，就是前面我们配置host 3. restart指定为always，使osd组件可以在down时重启。 4.privileged是用于指定该osd是专用的。 这里我们采用的是osd_directory 镜像模式")]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("start_mgr.sh")])]),s._v(" "),t("p",[s._v("#!/bin/bash\ndocker run -d --net=host  "),t("br"),s._v("\n--name=mgr "),t("br"),s._v("\n-v /etc/localtime:/etc/localtime "),t("br"),s._v("\n-v /usr/local/ceph/etc:/etc/ceph "),t("br"),s._v("\n-v /usr/local/ceph/lib:/var/lib/ceph "),t("br"),s._v("\n-v /usr/local/ceph/logs:/var/log/ceph "),t("br"),s._v("\nceph/daemon:latest-nautilus mgr\n这个脚本是用于启动mgr组件，它的主要作用是分担和扩展monitor的部分功能，提供图形化的管理界面以便我们更好的管理ceph存储系统。其启动脚本比较简单，在此不再赘述。")]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[s._v("start_rgw.sh")])]),s._v(" "),t("p",[s._v("#!/bin/bash\ndocker run "),t("br"),s._v("\n-d --net=host "),t("br"),s._v("\n--name=rgw "),t("br"),s._v("\n-v /etc/localtime:/etc/localtime "),t("br"),s._v("\n-v /usr/local/ceph/etc:/etc/ceph "),t("br"),s._v("\n-v /usr/local/ceph/lib:/var/lib/ceph "),t("br"),s._v("\n-v /usr/local/ceph/logs:/var/log/ceph "),t("br"),s._v("\nceph/daemon:latest-nautilus rgw\n该脚本主要是用于启动rgw组件，rgw（Rados GateWay）作为对象存储网关系统，一方面扮演RADOS集群客户端角色，为对象存储应用提供数据存储，另一方面扮演HTTP服务端角色，接受并解析互联网传送的数据。")]),s._v(" "),t("ol",{attrs:{start:"6"}},[t("li",[s._v("执行脚本\n启动mon\n首先在主节点ceph1上执行start_mon.sh脚本，启动后通过docker ps -a|grep mon查看启动结果，启动成功之后生成配置数据，在ceph主配置文件中，追加如下内容：\ncat >>/usr/local/ceph/etc/ceph.conf <<EOF")])]),s._v(" "),t("h1",{attrs:{id:"容忍更多的时钟误差"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#容忍更多的时钟误差"}},[s._v("#")]),s._v(" 容忍更多的时钟误差")]),s._v(" "),t("p",[s._v("mon clock drift allowed = 2\nmon clock drift warn backoff = 30")]),s._v(" "),t("h1",{attrs:{id:"允许删除pool"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#允许删除pool"}},[s._v("#")]),s._v(" 允许删除pool")]),s._v(" "),t("p",[s._v("mon_allow_pool_delete = true")]),s._v(" "),t("p",[s._v("[mgr]")]),s._v(" "),t("h1",{attrs:{id:"开启web仪表盘"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开启web仪表盘"}},[s._v("#")]),s._v(" 开启WEB仪表盘")]),s._v(" "),t("p",[s._v("mgr modules = dashboard\n[client.rgw.ceph1]")]),s._v(" "),t("h1",{attrs:{id:"设置rgw网关的web访问端口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置rgw网关的web访问端口"}},[s._v("#")]),s._v(" 设置rgw网关的web访问端口")]),s._v(" "),t("p",[s._v('rgw_frontends = "civetweb port=20003"\nEOF\n拷贝所有数据（已包含脚本）到另外2台服务器\nscp -r /usr/local/ceph ceph2:/usr/local/\nscp -r /usr/local/ceph ceph3:/usr/local/\n通过远程ssh，在ceph2和ceph3上依次启动mon(启动前不要修改ceph.conf文件)\nssh ceph2 bash /usr/local/ceph/admin/start_mon.sh\nssh ceph3 bash /usr/local/ceph/admin/start_mon.sh\n启动后通过 ceph -s查看集群状态，如果能够看到ceph2和ceph3,则表示集群创建成功，此时的状态应该是HEALTH_OK状态。')]),s._v(" "),t("p",[s._v("启动OSD\n在执行start_osd.sh脚本之前，首先需要在mon节点生成osd的密钥信息，不然直接启动会报错。命令如下：")]),s._v(" "),t("p",[s._v("docker exec -it mon ceph auth get client.bootstrap-osd -o /var/lib/ceph/bootstrap-osd/ceph.keyring\n接着在主节点下执行如下命令：")]),s._v(" "),t("p",[s._v("bash /usr/local/ceph/admin/start_osd.sh\nssh ceph2 bash /usr/local/ceph/admin/start_osd.sh\nssh ceph3 bash /usr/local/ceph/admin/start_osd.sh\n全部osd都启动之后，稍等片刻后，执行ceph -s查看状态，应该可以看到多了如下信息（总共3个osd）")]),s._v(" "),t("p",[s._v("osd: 3 osds: 3 up, 3 in\nPS: osd的个数最好维持在奇数个。")]),s._v(" "),t("p",[s._v("启动mgr\n直接在主节点ceph1上执行如下三个命令：")]),s._v(" "),t("p",[s._v("bash /usr/local/ceph/admin/start_mgr.sh\nssh ceph2 bash /usr/local/ceph/admin/start_mgr.sh\nssh ceph3 bash /usr/local/ceph/admin/start_mgr.sh\n启动rgw\n同样的我们首先还是需要先在mon节点生成rgw的密钥信息，命令如下：")]),s._v(" "),t("p",[s._v("docker exec mon ceph auth get client.bootstrap-rgw -o /var/lib/ceph/bootstrap-rgw/ceph.keyring\n接着在主节点ceph1上执行如下三个命令：")]),s._v(" "),t("p",[s._v("bash /usr/local/ceph/admin/start_rgw.sh\nssh ceph2 bash /usr/local/ceph/admin/start_rgw.sh\nssh ceph3 bash /usr/local/ceph/admin/start_rgw.sh\n启动完成之后再通过ceph-s查看集群的状态")]),s._v(" "),t("p",[s._v("安装Dashboard管理后台\n首先确定主节点，通过ceph -s命令查看集群状态，找到mgr为active的那个节点，如下：")]),s._v(" "),t("p",[s._v("mgr: ceph1(active), standbys: ceph2, ceph3\n这里的主节点就是ceph1节点。 1. 开启dashboard功能")]),s._v(" "),t("p",[s._v("docker exec mgr ceph mgr module enable dashboard\n创建登录用户与密码\ndocker exec mgr ceph dashboard set-login-credentials admin test\n这里设置用户名为admin,密码为test。 3. 配置外部访问端口个，这里指定端口号是18080，可以自定义修改")]),s._v(" "),t("p",[s._v("docker exec mgr ceph config set mgr mgr/dashboard/server_port 18080\n配置外部访问地址，这里我的主节点IP是192.168.161.137，你需要换成自己的IP地址。\ndocker exec mgr ceph config set mgr mgr/dashboard/server_addr 192.168.161.137\n关闭https(如果没有证书或内网访问， 可以关闭)\ndocker exec mgr ceph config set mgr mgr/dashboard/ssl false\n重启Mgr DashBoard服务\ndocker restart mgr\n查看Mgr DashBoard服务\ndocker exec mgr ceph mgr services\n最后通过 http://192.168.161.137:18080/#/dashboard 访问。")]),s._v(" "),t("p",[s._v("查看整个集群信息\n至此，整个集群就已经搭建完毕，通过ceph -s命令，可以查看整个集群信息，我们规划的所有节点都已创建成功并加入集群")]),s._v(" "),t("p",[s._v("关于重启mon服务失败问题")]),s._v(" "),t("p",[s._v("如果修改了配置或者宿主机出现问题， 需要重启mon服务， 会出现不能正常启动的问题，查看容器日志， 最后一行提示：")]),s._v(" "),t("p",[s._v("Existing mon, trying to rejoin cluster abort")]),s._v(" "),t("p",[s._v("没有具体的原因， 解决的办法是删除/usr/local/ceph/lib/mon目录， 再重新启动， 但这会破坏原有配置与数据， 影响集群的正常运转，这是我们不能接受的， 无耐，只有研究它的启动脚本。（ 这不是Docker容器问题， 是Ceph的镜像脚本编写有点问题。） 将脚本拷贝出来：")]),s._v(" "),t("p",[s._v("docker cp mon:/opt/ceph-container/bin/start_mon.sh .")]),s._v(" "),t("p",[s._v("找到并修改以下内容：")]),s._v(" "),t("h1",{attrs:{id:"注释此行-直接将v2v1复制为2-代表是走v2协议-以指定ip方式加入集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注释此行-直接将v2v1复制为2-代表是走v2协议-以指定ip方式加入集群"}},[s._v("#")]),s._v(" 注释此行，直接将v2v1复制为2，代表是走V2协议， 以指定IP方式加入集群")]),s._v(" "),t("p",[s._v("#v2v1=$(ceph-conf -c /etc/ceph/${CLUSTER}.conf 'mon host' | tr ',' '\\n' | grep -c ${MON_IP})")]),s._v(" "),t("p",[s._v("v2v1=2")]),s._v(" "),t("p",[s._v("再将脚本复制至容器内：")]),s._v(" "),t("p",[s._v("docker cp start_mon.sh mon:/opt/ceph-container/bin/start_mon.sh")]),s._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://blog.csdn.net/hxx688/article/details/103440967?spm=1001.2014.3001.5501",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/hxx688/article/details/103440967?spm=1001.2014.3001.5501"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/379440526",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://zhuanlan.zhihu.com/p/379440526"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://hub.docker.com/r/ceph/daemon",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://hub.docker.com/r/ceph/daemon"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);